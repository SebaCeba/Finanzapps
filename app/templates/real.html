{% extends "base.html" %}

{% block title %}Gasto Real Mensual | FinanzApp{% endblock %}

{% block content %}
<div class="contenedor">
    <h2 class="titulo-principal">Gasto Real vs Presupuesto</h2>

    <!-- Filtro AÃ±o/Mes -->
    <form method="get" action="{{ url_for('real.vista_real') }}" class="formulario-filtros">
        <label for="aÃ±o">AÃ±o:</label>
        <select name="aÃ±o" id="aÃ±o">
            {% for y in aÃ±os %}
                <option value="{{ y }}" {% if y == aÃ±o %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
        </select>

        <label for="mes">Mes:</label>
        <select name="mes" id="mes">
            {% for m in meses %}
                {% set nombre_mes = ['ene','feb','mar','abr','may','jun','jul','ago','sep','oct','nov','dic'][m - 1] %}
                <option value="{{ m }}" {% if m == mes %}selected{% endif %}>{{ nombre_mes }}</option>
            {% endfor %}
        </select>

        <button type="submit" class="boton boton-secundario">Actualizar</button>
    </form>

    <!-- BotÃ³n global para guardar -->
    <div style="text-align: right; margin-bottom: 24px;">
        <button id="guardar-todos" class="boton boton-azul">
            ðŸ’¾ Guardar todos los cambios
        </button>
    </div>

    <!-- MenÃº contextual -->
    <div id="floatingMenu" class="floating-menu"></div>

    <!-- Contenedor con scroll horizontal -->
    <div class="presupuesto-scroll-x">
        {% for tipo, nombre_bloque in [
            ("ingreso", "Ingresos"),
            ("gasto_fijo", "Necesidades"),
            ("gasto_variable", "Deseos"),
            ("ahorro", "Ahorro/Deuda")
        ] %}
        <div class="seccion-presupuesto">
            <h3 class="bloque-titulo">{{ nombre_bloque }}</h3>

            <form method="POST" action="{{ url_for('real.guardar_real') }}" class="form-bloque">
                <input type="hidden" name="aÃ±o" value="{{ aÃ±o }}">
                <input type="hidden" name="mes" value="{{ mes }}">
                <input type="hidden" name="tipo_actual" value="{{ tipo }}">

                <table class="tabla-bloque">
                    <thead>
                        <tr>
                            <th class="menu-acciones"></th>
                            <th class="sticky-categoria">CategorÃ­a</th>
                            <th>Presupuesto</th>
                            <th>Real</th>
                            <th>Diferencia</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for categoria, datos in data.items() if data_tipos[categoria] == tipo %}
                        <tr>
                            <td class="menu-acciones">
                                <button type="button" class="dropdown-btn"
                                        data-categoria="{{ categoria }}"
                                        data-categoria-id="{{ data_ids[categoria] }}"
                                        title="Opciones" tabindex="0">â‹®</button>
                            </td>
                            <td class="sticky-categoria">
                                <span class="nombre-categoria" data-categoria-id="{{ data_ids[categoria] }}">{{ categoria }}</span>
                                <input type="hidden" class="categoria-id" value="{{ data_ids[categoria] }}">
                            </td>
                            <td><input type="text" name="presupuesto[{{ categoria }}]" value="{{ datos.presupuesto }}"></td>
                            <td><input type="text" name="real[{{ categoria }}]" value="{{ datos.real }}"></td>
                            {% set diferencia = datos.real - datos.presupuesto %}
                            <td style="color: {{ 'red' if diferencia > 0 else 'green' }}">{{ diferencia }}</td>
                        </tr>
                        {% endfor %}

                        <!-- Fila oculta para nueva categorÃ­a -->
                        <tr class="nueva-fila" style="display: none;">
                            <td class="menu-acciones"></td>
                            <td class="sticky-categoria">
                                <input type="text" name="nueva_categoria" placeholder="Nueva categorÃ­a">
                            </td>
                            <td><input type="text" name="presupuesto[nueva_categoria]" value="0"></td>
                            <td><input type="text" name="real[nueva_categoria]" value="0"></td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>

                <div style="margin-top: 6px; text-align: left;">
                    <a href="#" class="aÃ±adir-categoria">+ AÃ±adir categorÃ­a</a>
                </div>
            </form>
        </div>
        {% endfor %}
    </div>
</div>

<script src="{{ url_for('static', filename='js/presupuesto.js') }}"></script>
{% endblock %}
