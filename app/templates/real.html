{% extends "base.html" %}
{% block title %}Real{% endblock %}

{% block content %}
<div style="margin: 32px;">
    <h2 style="text-align: center;">Gasto Real Mensual</h2>

    <form method="get" action="{{ url_for('real.vista_real') }}">
        <label style="margin-right: 8px;">Año:</label>
        <select name="año">
            {% for y in años %}
                <option value="{{ y }}" {% if y == año %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
        </select>

        <label style="margin-left: 16px; margin-right: 8px;">Mes:</label>
        <select name="mes">
            {% for m in meses %}
                {% set nombre_mes = ['ene', 'feb', 'mar', 'abr', 'may', 'jun', 'jul', 'ago', 'sep', 'oct', 'nov', 'dic'][m - 1] %}
                <option value="{{ m }}" {% if m == mes %}selected{% endif %}>{{ nombre_mes }}</option>
            {% endfor %}
        </select>

        <button type="submit">Actualizar</button>
    </form>

    <br>

    {% if mensaje %}
        <p style="color: gray;">{{ mensaje }}</p>
    {% endif %}

    {% for grupo in data %}
        <div class="grupo">
            <h3 style="background: #ffcc00; padding: 8px;">{{ grupo.nombre }}</h3>
            <table border="1" cellpadding="6" cellspacing="0" width="100%">
                <thead>
                    <tr>
                        <th>Categoría</th>
                        <th>Presupuesto</th>
                        <th>Real</th>
                        <th>Diferencia</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cat in grupo.subcategorias %}
                    {% set diff = cat.real - cat.presupuesto %}
                    <tr>
                        <td>{{ cat.nombre }}</td>
                        <td>{{ "%.0f"|format(cat.presupuesto) }}</td>
                        <td contenteditable="true" class="editable" data-id="{{ cat.id }}">{{ "%.0f"|format(cat.real) }}</td>
                        <td style="color: {{ 'red' if diff > 0 else 'green' }};">{{ "%.0f"|format(diff) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <br>
        </div>
    {% endfor %}
</div>

<script>
document.querySelectorAll('.editable').forEach(cell => {
    cell.addEventListener('blur', () => {
        const valor = parseFloat(cell.textContent) || 0;
        const categoriaId = cell.dataset.id;

        fetch('/real/guardar_monto', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ categoria_id: categoriaId, monto: valor })
        });
    });
});
</script>
{% endblock %}
